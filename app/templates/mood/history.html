{% extends "base.html" %}

{% block title %}å¿ƒæƒ…å†å²è®°å½•{% endblock %}

{% block page_content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-light text-gray-800 mb-2">
            <span class="bg-gradient-to-r from-blue-200 via-purple-200 to-pink-200 bg-clip-text text-transparent">
                å¿ƒæƒ…å†å²
            </span>
        </h1>
        <p class="text-gray-600">å›é¡¾è¿‡å»çš„æƒ…ç»ªå†ç¨‹ï¼Œå‘ç°å†…å¿ƒçš„æˆé•¿è½¨è¿¹</p>
    </div>

    <!-- æœç´¢æ  -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 border border-purple-100">
        <form action="{{ url_for('main.mood_history') }}" method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">å¼€å§‹æ—¥æœŸ</label>
                <input type="date" name="start_date" value="{{ request.args.get('start_date') or '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-300 focus:ring-2 focus:ring-purple-200 transition-all duration-300">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">ç»“æŸæ—¥æœŸ</label>
                <input type="date" name="end_date" value="{{ request.args.get('end_date') or '' }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-300 focus:ring-2 focus:ring-purple-200 transition-all duration-300">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">å¿ƒæƒ…ç±»å‹</label>
                <select name="mood_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-300 focus:ring-2 focus:ring-purple-200 transition-all duration-300">
                    <option value="">å…¨éƒ¨</option>
                    <option value="happy" {% if request.args.get('mood_type') == 'happy' %}selected{% endif %}>å¼€å¿ƒ</option>
                    <option value="calm" {% if request.args.get('mood_type') == 'calm' %}selected{% endif %}>å¹³é™</option>
                    <option value="anxious" {% if request.args.get('mood_type') == 'anxious' %}selected{% endif %}>ç„¦è™‘</option>
                    <option value="sad" {% if request.args.get('mood_type') == 'sad' %}selected{% endif %}>ä¼¤å¿ƒ</option>
                    <option value="angry" {% if request.args.get('mood_type') == 'angry' %}selected{% endif %}>æ„¤æ€’</option>
                </select>
            </div>
            <div class="flex items-end">
                <button type="submit" class="w-full px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium hover:from-purple-600 hover:to-pink-600 transition-all duration-300">
                    <i class="fas fa-search mr-2"></i>æœç´¢
                </button>
            </div>
        </form>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- å·¦ä¾§ï¼šå¿ƒæƒ…åˆ—è¡¨ -->
        <div class="lg:col-span-2">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            {% if month_stats.mood_distribution %}
            <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl p-6 mb-8 border border-blue-100">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-chart-bar text-blue-500 mr-2"></i>
                    æœ€è¿‘30å¤©ç»Ÿè®¡
                </h3>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                    {% for mood, count in month_stats.mood_distribution.items() %}
                    <div class="text-center">
                        <div class="text-2xl font-bold text-purple-600">{{ count }}</div>
                        <div class="text-sm text-gray-600">{{ mood }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- å¿ƒæƒ…è®°å½•åˆ—è¡¨ -->
            <div class="space-y-4" data-empty-message="è¿˜æ²¡æœ‰å¿ƒæƒ…è®°å½•ï¼Œå¿«æ¥è®°å½•ç¬¬ä¸€ä¸ªå¿ƒæƒ…å§ï¼">
                {% for mood in moods %}
                <div class="bg-white rounded-xl shadow-md p-6 border border-gray-100 hover:shadow-lg transition-all duration-300 hover:scale-[1.02]" data-item-id="{{ mood.id }}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center mb-3">
                                <div class="text-3xl mr-3">
                                    {% if mood.mood_type != 'custom' %}
                                        {{ Mood.MOOD_CONFIG[mood.mood_type].icon }}
                                    {% else %}
                                        ğŸ’­
                                    {% endif %}
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-800">
                                        {% if mood.mood_type != 'custom' %}
                                            {{ Mood.MOOD_CONFIG[mood.mood_type].label }}
                                        {% else %}
                                            {{ mood.custom_mood }}
                                        {% endif %}
                                    </h3>
                                    <p class="text-sm text-gray-500">
                                        å¿ƒæƒ…æ—¥æœŸ: {{ mood.date }}
                                        {% if mood.timestamp %}
                                        <span class="text-xs text-gray-400"> (è®°å½•äº: {{ moment(mood.timestamp).format('MM-DD HH:mm') }})</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>

                            <!-- å¿ƒæƒ…å¼ºåº¦ -->
                            <div class="mb-3">
                                <div class="flex items-center text-sm text-gray-600">
                                    <span class="mr-2">å¼ºåº¦:</span>
                                    <div class="flex-1 max-w-xs">
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-gradient-to-r from-blue-400 to-purple-400 h-2 rounded-full"
                                                 style="width: {{ mood.intensity * 10 }}%"></div>
                                        </div>
                                    </div>
                                    <span class="ml-2 font-medium">{{ mood.intensity }}/10</span>
                                </div>
                            </div>

                            <!-- æ—¥è®°å†…å®¹ -->
                            {% if mood.diary %}
                            <div class="text-gray-700 leading-relaxed">
                                <p class="whitespace-pre-wrap">{{ mood.diary }}</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="flex space-x-2 ml-4">
                            <a href="{{ url_for('main.mood_by_date', date_str=mood.date.isoformat()) }}"
                               class="text-blue-600 hover:text-blue-800 transition-colors">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button type="button" onclick="deleteMood({{ mood.id }})"
                                class="text-red-600 hover:text-red-800 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- åˆ†é¡µ -->
            {% if pagination.pages > 1 %}
            <div class="mt-8 flex justify-center">
                <nav class="flex items-center space-x-2">
                    {% if pagination.has_prev %}
                        <a href="{{ url_for('main.mood_history', page=pagination.prev_num, **request.args) }}"
                           class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            <i class="fas fa-chevron-left mr-1"></i>ä¸Šä¸€é¡µ
                        </a>
                    {% endif %}

                    {% for page in pagination.iter_pages() %}
                        {% if page %}
                            {% if page != pagination.page %}
                            <a href="{{ url_for('main.mood_history', page=page, **request.args) }}"
                               class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                                {{ page }}
                            </a>
                            {% else %}
                            <span class="px-3 py-2 text-sm font-medium text-white bg-purple-600 border border-purple-600 rounded-md">
                                {{ page }}
                            </span>
                            {% endif %}
                        {% else %}
                        <span class="px-3 py-2 text-sm font-medium text-gray-500">...</span>
                        {% endif %}
                    {% endfor %}

                    {% if pagination.has_next %}
                        <a href="{{ url_for('main.mood_history', page=pagination.next_num, **request.args) }}"
                           class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            ä¸‹ä¸€é¡µ<i class="fas fa-chevron-right ml-1"></i>
                        </a>
                    {% endif %}
                </nav>
            </div>
            {% endif %}
        </div>

        <!-- å³ä¾§ï¼šå›¾è¡¨åŒºåŸŸ -->
        <div class="lg:col-span-1">
            <!-- Recharts å›¾è¡¨å°†åœ¨è¿™é‡Œ -->
            <div class="bg-white rounded-2xl shadow-lg p-6 border border-purple-100">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-chart-line text-purple-500 mr-2"></i>
                    æƒ…ç»ªè¶‹åŠ¿å›¾
                </h3>
                <div id="mood-chart" style="height: 300px;">
                    <!-- Recharts å›¾è¡¨æ¸²æŸ“åŒºåŸŸ -->
                </div>
            </div>

            <!-- å¿ƒæƒ…æ—¥å†å¿«æ·å…¥å£ -->
            <div class="bg-gradient-to-br from-green-100 to-blue-100 rounded-2xl p-6 mt-6 border border-green-200">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-calendar-alt text-green-500 mr-2"></i>
                    å¿ƒæƒ…æ—¥å†
                </h3>
                <p class="text-gray-600 text-sm mb-4">ä»¥æ—¥å†å½¢å¼æŸ¥çœ‹å¿ƒæƒ…å˜åŒ–</p>
                <a href="{{ url_for('main.mood_calendar') }}"
                   class="block w-full text-center px-4 py-3 bg-white rounded-xl text-green-600 font-medium hover:bg-green-50 transition-colors duration-300 shadow-sm hover:shadow-md">
                    æŸ¥çœ‹æ—¥å†
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Recharts åº“ -->
<script src="https://cdn.jsdelivr.net/npm/recharts@2.8.0/umd/Recharts.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // å‡†å¤‡å›¾è¡¨æ•°æ®
    const dailyMoods = {{ month_stats.daily_moods | tojson | safe }};
    const chartData = [];

    // ç”Ÿæˆæœ€è¿‘30å¤©çš„æ•°æ®
    for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];

        const moodData = dailyMoods[dateStr];
        if (moodData) {
            chartData.push({
                date: date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }),
                intensity: moodData.intensity,
                mood: moodData.mood
            });
        } else {
            chartData.push({
                date: date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }),
                intensity: null,
                mood: null
            });
        }
    }

    // æ¸²æŸ“å›¾è¡¨
    const moodChart = Recharts.createChart(Recharts.LineChart, {
        data: chartData,
        margin: { top: 5, right: 30, left: 20, bottom: 5 }
    });

    moodChart.render(
        document.getElementById('mood-chart'),
        [
            Recharts.createElement(Recharts.CartesianGrid, { strokeDasharray: '3 3' }),
            Recharts.createElement(Recharts.XAxis, { dataKey: 'date' }),
            Recharts.createElement(Recharts.YAxis, { domain: [0, 10] }),
            Recharts.createElement(Recharts.Tooltip, {
                content: function(props) {
                    if (props.active && props.payload && props.payload[0]) {
                        const data = props.payload[0].payload;
                        return `
                            <div class="bg-white p-3 border rounded shadow-lg">
                                <p class="font-medium">${data.date}</p>
                                <p class="text-sm">å¿ƒæƒ…: ${data.mood || 'æœªè®°å½•'}</p>
                                <p class="text-sm">å¼ºåº¦: ${data.intensity || '-'}</p>
                            </div>
                        `;
                    }
                    return null;
                }
            }),
            Recharts.createElement(Recharts.Line, {
                type: 'monotone',
                dataKey: 'intensity',
                stroke: '#8b5cf6',
                strokeWidth: 2,
                dot: { fill: '#8b5cf6', r: 4 },
                connectNulls: false
            })
        ]
    );
});

// å¿ƒæƒ…åˆ é™¤å‡½æ•° - ä½¿ç”¨å…¬å…±åº“
function deleteMood(moodId) {
    if (typeof deleteManager === 'undefined') {
        alert('åˆ é™¤åŠŸèƒ½æš‚ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return;
    }

    deleteManager.confirmDelete('mood', moodId, 'è¿™æ¡å¿ƒæƒ…è®°å½•', {
        containerSelector: '.space-y-4'
    });
}
</script>
{% endblock %}